Insurance Cost Estimator
========================================================

```{r setup}
require(knitr)
require(plyr)
require(ggplot2)
source('func.r')
```


## Declare available policies

Policy attributes include a name, the individual deductible, the family deductible, the copay percentage (as the share paid by the insurer), the individual out-of-pocket maximum, the family out-of-pocket maximum, and the monthly premium.


```{r policies}

policies <- rbind(
    data.frame(policy.name='2014 CIGNA Choice Fund with HSA' , ind.deductible=1500, fam.deductible=3000, copay.pct=.80, ind.oop.max=1500, fam.oop.max=12000, premium=(186.75*2))
,
    data.frame(policy.name='2014 CIGNA OAP (PPO) Standard Plan' , ind.deductible=600, fam.deductible=1200, copay.pct=.80, ind.oop.max=600, fam.oop.max=4800, premium=(236.67*2))
,
    data.frame(policy.name='2013 CIGNA OAP (PPO) Gold Plan' , ind.deductible=600, fam.deductible=1200, copay.pct=.80, ind.oop.max=2400, fam.oop.max=4800, premium=(166.67*2))
)
policies$policy.id <- row.names(policies)

```

## Declare family members

Each family member has a name, a baseline cost for doctor's visits, a risk of incurring sickness-related expenses, and a risk of catastrophic indury or illness. 

The risk factors are probabilities passed to a binomial distribution. If the result is 1, a Poisson distribution is used to estimate costs. 

In the following sample family, Parent A visits the doctor less than Parent A, and the children are more likely to get sick. Everyone has a 1% chance of catastrophic sickness or injury.

```{r insured}
insured <- rbind(
    data.frame(Name='Parent A',  VisitBase=150,  SickRisk=0.1, CatRisk=0.01)
    ,
    data.frame(Name='Parent B' , VisitBase=500,  SickRisk=0.2, CatRisk=0.01)
    ,
    data.frame(Name='Child C' ,  VisitBase=250,  SickRisk=0.4, CatRisk=0.01)
    ,
    data.frame(Name='Child D' ,  VisitBase=250,  SickRisk=0.4, CatRisk=0.01)
    ,
    data.frame(Name='Child E' ,  VisitBase=250,  SickRisk=0.4, CatRisk=0.01)
      ,
    data.frame(Name='Child F' ,  VisitBase=250,  SickRisk=0.4, CatRisk=0.01)
        ,
    data.frame(Name='Child CG' ,  VisitBase=250,  SickRisk=0.4, CatRisk=0.01)
)
```


## Run _n_ iterations of the family's possible years with each policy

```{r func.yr}
n <- 500
costs <- yearcosts(insured, n)
subset(costs, cost.iteration == 1)
# The `scenarios` are unique combinations of each policy, family member, and iteration year
scenarios <- explode.scenarios(costs, policies)
head(scenarios)
str(scenarios)
# subset(scenarios, cost.iteration == 1)

# the calculate_family() function aggregates the scenarios to the family level
results <- calculate.family(scenarios)
head(results)
```


Measure the probability densities of the results, by policy. Assign some tail boundaries of interest for later graphing.


```{r densities}
tail.limit.left <- 0.333
tail.limit.right <- 0.666
dxy <- ddply(results, .(policy.name), summarize, dx=density(fam.net.capped)$x, dy=density(fam.net.capped)$y )
dxy <- ddply(dxy, .(policy.name), transform, qleft=quantile(dx, tail.limit.left), qright=quantile(dx, tail.limit.right))
dxy$ytail <- ifelse(dxy$dx <= dxy$qleft | dxy$dx >= dxy$qright , dxy$dy, 0)

```

Plot the outcomes

```{r plot.outcomes}
ggplot(results) + geom_density(aes(x=fam.net.capped)) +
  geom_area(data=dxy,aes(x=dx,y=ytail ), fill="green",colour=NA,alpha=0.5) +
  geom_vline(aes(xintercept=fam.net.max),color='red') + 
  facet_wrap( ~ policy.name, ncol=1)

ggplot(results) + geom_histogram(aes(x=fam.net.capped), binwidth=100) +geom_vline(aes(xintercept=fam.net.max),color='red')+ facet_wrap( ~ policy.name, ncol=1)

```

Create some range spans so the x axis on each graph can how much of the net costs are composed of premiums (orange box), deductible costs paid at 100% (yellow box), and post-deductible copays (the amount between the yellow box and the total cost).


```{r ranges}
ranges <- policies
# annualize the monthly premium
ranges$premium <- ranges$premium * 12
# Calculate the premium + deductible out-of-pocket baseline
ranges$dedplusprem <- ranges$fam.deductible + ranges$premium 
dummyranges <- ranges
dummyranges$dedplusprem <- dummyranges$premium 
dummyranges$premium <- 0
ranges <- rbind(dummyranges, ranges)
```

Plot the ranges behind the distribution graphs.

```{r combined plot}
ggplot(results, aes(x=fam.net.capped)) +
  geom_histogram(aes(y = ..density..), binwidth=density(results$fam.net.capped)$bw) +
  geom_area(data=ranges, aes(x=premium , y=0.0015) , fill="orange", alpha=0.5) + 
  geom_area(data=ranges, aes(x=dedplusprem, y=0.0015) , fill="yellow", alpha=0.5) +
  geom_area(data=dxy,aes(x=dx,y=ytail ), fill="green",colour=NA,alpha=0.5) +
  geom_vline(aes(xintercept=fam.net.max),color='red') +
  geom_density(color="blue") +
  facet_wrap( ~ policy.name, ncol=1) +
  scale_y_continuous(limits=c(0,0.0025)) +
  scale_x_continuous("Net family costs", limits=c(0, 30000))
```

